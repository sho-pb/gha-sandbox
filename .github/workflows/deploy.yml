name: Deploy

on:
  workflow_dispatch:
    inputs:
      commitHash:
        required: true

permissions:
  contents: write
  pull-requests: write

jobs:
  versioning:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create release branch and force push
        run: |
          git fetch origin
          git checkout ${{ inputs.commitHash }}
          branch_name="release/${{ inputs.commitHash }}"
          git switch -c "$branch_name"
          git push origin "$branch_name"

      - name: Generate release notes using GitHub API
        id: release_notes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          BASE: main
          HEAD: release/${{ inputs.commitHash }}
        run: |
          gh api \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            /repos/$REPO/releases/generate-notes \
            -f tag_name="$HEAD" \
            -f target_commitish="$HEAD" \
            -f previous_tag_name="$BASE" \
          > generated_notes.json

          cat generated_notes.json | jq -r '.body' > pr_body.txt

      - name: Create Pull Request to main
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          branch_name="release/${{ inputs.commitHash }}"
          gh pr create \
            --title "Deploy: $branch_name" \
            --body-file pr_body.txt \
            --base main \
            --head "$branch_name"